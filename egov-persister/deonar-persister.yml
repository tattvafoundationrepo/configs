serviceMaps:
  serviceName: deonar-services
  mappings:
    - version: 1.0
      description: Persists Deonar arrival details
      fromTopic: topic_deonar_arrival
      isTransaction: true
      queryMaps:
        - query: |
            INSERT INTO eg_deonar_arrival 
            (arrivalId, importPermission, stakeholderId, permissiondate, timeOfArrival, vehicleNumber, createdAt, updatedAt, createdBy, updatedBy)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            ON CONFLICT (arrivalId)
            DO UPDATE SET 
              importPermission = EXCLUDED.importPermission,
              stakeholderId = EXCLUDED.stakeholderId,
              permissiondate = EXCLUDED.permissiondate,
              timeOfArrival = EXCLUDED.timeOfArrival,
              vehicleNumber = EXCLUDED.vehicleNumber,
              updatedAt = EXCLUDED.updatedAt,
              updatedBy = EXCLUDED.updatedBy
            RETURNING id;
          basePath: $.ArrivalDetails
          jsonMaps:
            - jsonPath: $.ArrivalDetails.arrivalId
            - jsonPath: $.ArrivalDetails.importPermission
            - jsonPath: $.ArrivalDetails.stakeholderId
            - jsonPath: $.ArrivalDetails.permissionDate
            - jsonPath: $.ArrivalDetails.timeOfArrival
            - jsonPath: $.ArrivalDetails.vehicleNumber
            - jsonPath: $.ArrivalDetails.createdAt
            - jsonPath: $.ArrivalDetails.updatedAt
            - jsonPath: $.ArrivalDetails.createdBy
            - jsonPath: $.ArrivalDetails.updatedBy

        - query: |
            INSERT INTO eg_deonar_animal_at_arrival 
            (arrivalId, animalTypeId, count, createdAt, updatedAt, createdBy, updatedBy)
            VALUES ((SELECT id FROM eg_deonar_arrival WHERE arrivalId = ?), ?, ?, ?, ?, ?, ?)
            ON CONFLICT (arrivalId, animalTypeId,count)
            DO UPDATE SET
              updatedAt = EXCLUDED.updatedAt,
              updatedBy = EXCLUDED.updatedBy;
          basePath: $.saveAnimalDetails.*
          jsonMaps:
            - jsonPath: $.ArrivalDetails.arrivalId
            - jsonPath: $.saveAnimalDetails.*.animalTypeId
            - jsonPath: $.saveAnimalDetails.*.tokenNum
            - jsonPath: $.saveAnimalDetails.*.createdAt
            - jsonPath: $.saveAnimalDetails.*.updatedAt
            - jsonPath: $.saveAnimalDetails.*.createdBy
            - jsonPath: $.saveAnimalDetails.*.updatedBy
  

    - version: 1.0
      description: Persists Deonar Inspection details
      fromTopic: save-inspection-details
      isTransaction: true
      queryMaps:
        - query: |
            INSERT INTO eg_deonar_inspection
            (inspectiondate, inspectiontime, arrivalid, employeeid, createdat, updatedat, createdby, updatedby, inspectionunitid, inspectiontype)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            ON CONFLICT (arrivalid,inspectiontype)
            DO UPDATE SET 
              inspectiontime = EXCLUDED.inspectiontime,
              arrivalid = EXCLUDED.arrivalid,
              employeeid = EXCLUDED.employeeid,
              updatedat = EXCLUDED.updatedat,
              updatedby = EXCLUDED.updatedby,
              inspectionunitid = EXCLUDED.inspectionunitid,
              inspectiontype = EXCLUDED.inspectiontype
            RETURNING id;
          basePath: $.Inspection
          jsonMaps:
            - jsonPath: $.Inspection.inspectionDate
            - jsonPath: $.Inspection.inspectionTime
            - jsonPath: $.Inspection.arrivalId
            - jsonPath: $.Inspection.employeeId
            - jsonPath: $.Inspection.createdAt
            - jsonPath: $.Inspection.updatedAt
            - jsonPath: $.Inspection.createdBy
            - jsonPath: $.Inspection.updatedBy
            - jsonPath: $.Inspection.inspectionUnitId
            - jsonPath: $.Inspection.inspectionType

        - query: |
            INSERT INTO eg_deonar_inspection_detail
            (inspectionid, createdat, updatedat, createdby, updatedby, report, tokenno, "resultremark",animaltypeid)
            VALUES ((SELECT id FROM eg_deonar_inspection WHERE arrivalid = ? and inspectiontype = ?), ?, ?, ?, ?, ?::jsonb, ?, ?,?)
            ON CONFLICT (inspectionid,animaltypeid,tokenno)
            DO UPDATE SET 
              updatedat = EXCLUDED.updatedat,
              updatedby = EXCLUDED.updatedby,
              report = EXCLUDED.report::jsonb,
              "resultremark" = EXCLUDED."resultremark";
          basePath: $.InspectionDetail
          jsonMaps:
            - jsonPath: $.Inspection.arrivalId
            - jsonPath: $.Inspection.inspectionType
            - jsonPath: $.InspectionDetail.createdAt
            - jsonPath: $.InspectionDetail.updatedAt 
            - jsonPath: $.InspectionDetail.createdBy
            - jsonPath: $.InspectionDetail.updatedBy
            - jsonPath: $.InspectionDetail.report
            - jsonPath: $.InspectionDetail.tokenNo
            - jsonPath: $.InspectionDetail.resultRemark
            - jsonPath: $.InspectionDetail.animalTypeId




    - version: 1.0
      description: Persists animal assignment details in the table
      fromTopic: save-animal-assignment
      isTransaction: true
      queryMaps:
        - query: >
            INSERT INTO public.eg_deonar_animal_assignment (
              arrivalid, animaltypeid, tokennum, stakeholderid, createdat, updatedat, createdby, updatedby
            ) VALUES ((SELECT id FROM eg_deonar_arrival WHERE arrivalId = ?), ?, ?, ?, ?, ?, ?, ?)
          basePath: $.animalAssignments.*
          jsonMaps:
            - jsonPath: $.arrivalId
            - jsonPath: $.animalAssignments.*.animalTypeId
            - jsonPath: $.animalAssignments.*.token
            - jsonPath: $.animalAssignments.*.assignedStakeholder
            - jsonPath: $.animalAssignments.*.createdAt
            - jsonPath: $.animalAssignments.*.updatedAt
            - jsonPath: $.animalAssignments.*.createdBy
            - jsonPath: $.animalAssignments.*.updatedBy
        




        
