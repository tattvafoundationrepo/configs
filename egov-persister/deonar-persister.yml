serviceMaps:
  serviceName: deonar-services
  mappings:
    - version: 1.0
      description: Persists Deonar arrival details
      fromTopic: topic_deonar_arrival
      isTransaction: true
      queryMaps:
        - query:  |
                  INSERT INTO eg_deonar_arrival 
                  (arrivalId, importPermission, stakeholderId, dateOfArrival, timeOfArrival, vehicleNumber, createdAt, updatedAt, createdBy, updatedBy) 
                  VALUES (?,?, ?, ?, ?, ?, ?, ?, ?, ?)
                  RETURNING id;
          basePath: $.ArrivalDetails
          jsonMaps:
            - jsonPath: $.ArrivalDetails.arrivalId
            - jsonPath: $.ArrivalDetails.importPermission
            - jsonPath: $.ArrivalDetails.stakeholderId
            - jsonPath: $.ArrivalDetails.dateOfArrival
            - jsonPath: $.ArrivalDetails.timeOfArrival
            - jsonPath: $.ArrivalDetails.vehicleNumber
            - jsonPath: $.ArrivalDetails.createdAt
            - jsonPath: $.ArrivalDetails.updatedAt
            - jsonPath: $.ArrivalDetails.createdBy
            - jsonPath: $.ArrivalDetails.updatedBy
        - query:  |
                  INSERT INTO eg_deonar_animal_at_arrival 
                  (arrivalId, animalTypeId, count, createdAt, updatedAt, createdBy, updatedBy)
                  VALUES ((select id from eg_deonar_arrival  where arrivalId = ?), ?, ?, ?, ?, ?, ?);
          basePath: $.AnimalDetails.* # Reference directly without [*] to align with Java handling
          jsonMaps:
            - jsonPath: $.ArrivalDetails.arrivalId
            - jsonPath: $.AnimalDetails.*.animalTypeId
            - jsonPath: $.AnimalDetails.*.count
            - jsonPath: $.AnimalDetails.*.createdAt
            - jsonPath: $.AnimalDetails.*.updatedAt
            - jsonPath: $.AnimalDetails.*.createdBy
            - jsonPath: $.AnimalDetails.*.updatedBy

  

    - version: 1.0
      description: Persists Deonar Inspection details
      fromTopic: save-inspection-details
      isTransaction: true
      queryMaps:
        - query: |
            INSERT INTO eg_deonar_inspection
            (inspectiondate, inspectiontime, arrivalid, employeeid, createdat, updatedat, createdby, updatedby, inspectionunitid, inspectiontype)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            ON CONFLICT (arrivalid,inspectiontype)
            DO UPDATE SET 
              inspectiontime = EXCLUDED.inspectiontime,
              arrivalid = EXCLUDED.arrivalid,
              employeeid = EXCLUDED.employeeid,
              updatedat = EXCLUDED.updatedat,
              updatedby = EXCLUDED.updatedby,
              inspectionunitid = EXCLUDED.inspectionunitid,
              inspectiontype = EXCLUDED.inspectiontype
            RETURNING id;
          basePath: $.Inspection
          jsonMaps:
            - jsonPath: $.Inspection.inspectionDate
            - jsonPath: $.Inspection.inspectionTime
            - jsonPath: $.Inspection.arrivalId
            - jsonPath: $.Inspection.employeeId
            - jsonPath: $.Inspection.createdAt
            - jsonPath: $.Inspection.updatedAt
            - jsonPath: $.Inspection.createdBy
            - jsonPath: $.Inspection.updatedBy
            - jsonPath: $.Inspection.inspectionUnitId
            - jsonPath: $.Inspection.inspectionType

        - query: |
            INSERT INTO eg_deonar_inspection_detail
            (inspectionid, createdat, updatedat, createdby, updatedby, report, tokenno, "resultRemark")
            VALUES ((SELECT id FROM eg_deonar_inspection WHERE arrivalid = ? and inspectiontype = ?), ?, ?, ?, ?, ?::jsonb, ?, ?)
            ON CONFLICT (inspectionid, tokenno)
            DO UPDATE SET 
              updatedat = EXCLUDED.updatedat,
              updatedby = EXCLUDED.updatedby,
              report = EXCLUDED.report::jsonb,
              "resultRemark" = EXCLUDED."resultRemark";
          basePath: $.InspectionDetail
          jsonMaps:
            - jsonPath: $.Inspection.arrivalId
            - jsonPath: $.Inspection.inspectionType
            - jsonPath: $.InspectionDetail.createdAt
            - jsonPath: $.InspectionDetail.updatedAt 
            - jsonPath: $.InspectionDetail.createdBy
            - jsonPath: $.InspectionDetail.updatedBy
            - jsonPath: $.InspectionDetail.report
            - jsonPath: $.InspectionDetail.tokenNo
            - jsonPath: $.InspectionDetail.resultRemark
        
